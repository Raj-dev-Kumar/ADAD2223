{"ast":null,"code":"\"use strict\";\n\n//  NOTICE\n//  Copyright 2015 D2L Corporation\n//\n//  Licensed under the Apache License, Version 2.0 (the \"License\");\n//  you may not use this file except in compliance with the License.\n//  You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n//  Unless required by applicable law or agreed to in writing, software\n//  distributed under the License is distributed on an \"AS IS\" BASIS,\n//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n//  See the License for the specific language governing permissions and\n//  limitations under the License.\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.joseToDer = exports.derToJose = void 0;\n// The following code is adapted from https://github.com/Brightspace/node-ecdsa-sig-formatter\nvar base64_js_1 = require(\"base64-js\");\nvar base64Url_1 = require(\"./base64Url\");\nfunction getParamSize(keySize) {\n  return (keySize / 8 | 0) + (keySize % 8 === 0 ? 0 : 1);\n}\nvar paramBytesForAlg = {\n  ES256: getParamSize(256),\n  ES384: getParamSize(384),\n  ES512: getParamSize(521)\n};\nfunction getParamBytesForAlg(alg) {\n  var paramBytes = paramBytesForAlg[alg];\n  if (paramBytes) {\n    return paramBytes;\n  }\n  throw new Error(\"Unknown algorithm \\\"\".concat(alg, \"\\\"\"));\n}\nvar MAX_OCTET = 0x80;\nvar CLASS_UNIVERSAL = 0;\nvar PRIMITIVE_BIT = 0x20;\nvar TAG_SEQ = 0x10;\nvar TAG_INT = 0x02;\nvar ENCODED_TAG_SEQ = TAG_SEQ | PRIMITIVE_BIT | CLASS_UNIVERSAL << 6;\nvar ENCODED_TAG_INT = TAG_INT | CLASS_UNIVERSAL << 6;\nfunction signatureAsBytes(signature) {\n  if (signature instanceof Uint8Array) {\n    return signature;\n  } else if ('string' === typeof signature) {\n    return (0, base64_js_1.toByteArray)((0, base64Url_1.pad)(signature));\n  }\n  throw new TypeError('ECDSA signature must be a Base64 string or a Uint8Array');\n}\nfunction derToJose(signature, alg) {\n  var signatureBytes = signatureAsBytes(signature);\n  var paramBytes = getParamBytesForAlg(alg);\n  // the DER encoded param should at most be the param size, plus a padding\n  // zero, since due to being a signed integer\n  var maxEncodedParamLength = paramBytes + 1;\n  var inputLength = signatureBytes.length;\n  var offset = 0;\n  if (signatureBytes[offset++] !== ENCODED_TAG_SEQ) {\n    throw new Error('Could not find expected \"seq\"');\n  }\n  var seqLength = signatureBytes[offset++];\n  if (seqLength === (MAX_OCTET | 1)) {\n    seqLength = signatureBytes[offset++];\n  }\n  if (inputLength - offset < seqLength) {\n    throw new Error(\"\\\"seq\\\" specified length of \\\"\".concat(seqLength, \"\\\", only \\\"\").concat(inputLength - offset, \"\\\" remaining\"));\n  }\n  if (signatureBytes[offset++] !== ENCODED_TAG_INT) {\n    throw new Error('Could not find expected \"int\" for \"r\"');\n  }\n  var rLength = signatureBytes[offset++];\n  if (inputLength - offset - 2 < rLength) {\n    throw new Error(\"\\\"r\\\" specified length of \\\"\".concat(rLength, \"\\\", only \\\"\").concat(inputLength - offset - 2, \"\\\" available\"));\n  }\n  if (maxEncodedParamLength < rLength) {\n    throw new Error(\"\\\"r\\\" specified length of \\\"\".concat(rLength, \"\\\", max of \\\"\").concat(maxEncodedParamLength, \"\\\" is acceptable\"));\n  }\n  var rOffset = offset;\n  offset += rLength;\n  if (signatureBytes[offset++] !== ENCODED_TAG_INT) {\n    throw new Error('Could not find expected \"int\" for \"s\"');\n  }\n  var sLength = signatureBytes[offset++];\n  if (inputLength - offset !== sLength) {\n    throw new Error(\"\\\"s\\\" specified length of \\\"\".concat(sLength, \"\\\", expected \\\"\").concat(inputLength - offset, \"\\\"\"));\n  }\n  if (maxEncodedParamLength < sLength) {\n    throw new Error(\"\\\"s\\\" specified length of \\\"\".concat(sLength, \"\\\", max of \\\"\").concat(maxEncodedParamLength, \"\\\" is acceptable\"));\n  }\n  var sOffset = offset;\n  offset += sLength;\n  if (offset !== inputLength) {\n    throw new Error(\"Expected to consume entire array, but \\\"\".concat(inputLength - offset, \"\\\" bytes remain\"));\n  }\n  var rPadding = paramBytes - rLength;\n  var sPadding = paramBytes - sLength;\n  var dst = new Uint8Array(rPadding + rLength + sPadding + sLength);\n  for (offset = 0; offset < rPadding; ++offset) {\n    dst[offset] = 0;\n  }\n  dst.set(signatureBytes.subarray(rOffset + Math.max(-rPadding, 0), rOffset + rLength), offset);\n  offset = paramBytes;\n  for (var o = offset; offset < o + sPadding; ++offset) {\n    dst[offset] = 0;\n  }\n  dst.set(signatureBytes.subarray(sOffset + Math.max(-sPadding, 0), sOffset + sLength), offset);\n  return (0, base64Url_1.escape)((0, base64_js_1.fromByteArray)(dst));\n}\nexports.derToJose = derToJose;\nfunction countPadding(buf, start, stop) {\n  var padding = 0;\n  while (start + padding < stop && buf[start + padding] === 0) {\n    ++padding;\n  }\n  var needsSign = buf[start + padding] >= MAX_OCTET;\n  if (needsSign) {\n    --padding;\n  }\n  return padding;\n}\nfunction joseToDer(signature, alg) {\n  signature = signatureAsBytes(signature);\n  var paramBytes = getParamBytesForAlg(alg);\n  var signatureBytes = signature.length;\n  if (signatureBytes !== paramBytes * 2) {\n    throw new TypeError(\"\\\"\".concat(alg, \"\\\" signatures must be \\\"\").concat(paramBytes * 2, \"\\\" bytes, saw \\\"\").concat(signatureBytes, \"\\\"\"));\n  }\n  var rPadding = countPadding(signature, 0, paramBytes);\n  var sPadding = countPadding(signature, paramBytes, signature.length);\n  var rLength = paramBytes - rPadding;\n  var sLength = paramBytes - sPadding;\n  var rsBytes = 1 + 1 + rLength + 1 + 1 + sLength;\n  var shortLength = rsBytes < MAX_OCTET;\n  var dst = new Uint8Array((shortLength ? 2 : 3) + rsBytes);\n  var offset = 0;\n  dst[offset++] = ENCODED_TAG_SEQ;\n  if (shortLength) {\n    // Bit 8 has value \"0\"\n    // bits 7-1 give the length.\n    dst[offset++] = rsBytes;\n  } else {\n    // Bit 8 of first octet has value \"1\"\n    // bits 7-1 give the number of additional length octets.\n    dst[offset++] = MAX_OCTET | 1;\n    // length, base 256\n    dst[offset++] = rsBytes & 0xff;\n  }\n  dst[offset++] = ENCODED_TAG_INT;\n  dst[offset++] = rLength;\n  if (rPadding < 0) {\n    dst[offset++] = 0;\n    dst.set(signature.subarray(0, paramBytes), offset);\n    offset += paramBytes;\n  } else {\n    dst.set(signature.subarray(rPadding, paramBytes), offset);\n    offset += paramBytes - rPadding;\n  }\n  dst[offset++] = ENCODED_TAG_INT;\n  dst[offset++] = sLength;\n  if (sPadding < 0) {\n    dst[offset++] = 0;\n    dst.set(signature.subarray(paramBytes), offset);\n  } else {\n    dst.set(signature.subarray(paramBytes + sPadding), offset);\n  }\n  return dst;\n}\nexports.joseToDer = joseToDer;","map":{"version":3,"names":["base64_js_1","require","base64Url_1","getParamSize","keySize","paramBytesForAlg","ES256","ES384","ES512","getParamBytesForAlg","alg","paramBytes","Error","concat","MAX_OCTET","CLASS_UNIVERSAL","PRIMITIVE_BIT","TAG_SEQ","TAG_INT","ENCODED_TAG_SEQ","ENCODED_TAG_INT","signatureAsBytes","signature","Uint8Array","toByteArray","pad","TypeError","derToJose","signatureBytes","maxEncodedParamLength","inputLength","length","offset","seqLength","rLength","rOffset","sLength","sOffset","rPadding","sPadding","dst","set","subarray","Math","max","o","escape","fromByteArray","exports","countPadding","buf","start","stop","padding","needsSign","joseToDer","rsBytes","shortLength"],"sources":["ecdsaSigFormatter.ts"],"sourcesContent":[null],"mappings":";;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;AAEA;AAEA,IAAAA,WAAA,GAAAC,OAAA;AACA,IAAAC,WAAA,GAAAD,OAAA;AAEA,SAASE,YAAYA,CAACC,OAAe;EACnC,OAAO,CAAEA,OAAO,GAAG,CAAC,GAAI,CAAC,KAAKA,OAAO,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;AAC1D;AAIA,IAAMC,gBAAgB,GAAG;EACvBC,KAAK,EAAEH,YAAY,CAAC,GAAG,CAAC;EACxBI,KAAK,EAAEJ,YAAY,CAAC,GAAG,CAAC;EACxBK,KAAK,EAAEL,YAAY,CAAC,GAAG;CACD;AAExB,SAASM,mBAAmBA,CAACC,GAAQ;EACnC,IAAMC,UAAU,GAAGN,gBAAgB,CAACK,GAAG,CAAC;EACxC,IAAIC,UAAU,EAAE;IACd,OAAOA,UAAU;;EAGnB,MAAM,IAAIC,KAAK,wBAAAC,MAAA,CAAuBH,GAAG,OAAG,CAAC;AAC/C;AAEA,IAAMI,SAAS,GAAG,IAAI;AACtB,IAAMC,eAAe,GAAG,CAAC;AACzB,IAAMC,aAAa,GAAG,IAAI;AAC1B,IAAMC,OAAO,GAAG,IAAI;AACpB,IAAMC,OAAO,GAAG,IAAI;AACpB,IAAMC,eAAe,GAAGF,OAAO,GAAGD,aAAa,GAAID,eAAe,IAAI,CAAE;AACxE,IAAMK,eAAe,GAAGF,OAAO,GAAIH,eAAe,IAAI,CAAE;AAExD,SAASM,gBAAgBA,CAACC,SAA8B;EACtD,IAAIA,SAAS,YAAYC,UAAU,EAAE;IACnC,OAAOD,SAAS;GACjB,MAAM,IAAI,QAAQ,KAAK,OAAOA,SAAS,EAAE;IACxC,OAAO,IAAAtB,WAAA,CAAAwB,WAAW,EAAC,IAAAtB,WAAA,CAAAuB,GAAG,EAACH,SAAS,CAAC,CAAC;;EAGpC,MAAM,IAAII,SAAS,CAAC,yDAAyD,CAAC;AAChF;AAEA,SAAgBC,SAASA,CAACL,SAA8B,EAAEZ,GAAQ;EAChE,IAAMkB,cAAc,GAAGP,gBAAgB,CAACC,SAAS,CAAC;EAClD,IAAMX,UAAU,GAAGF,mBAAmB,CAACC,GAAG,CAAC;EAE3C;EACA;EACA,IAAMmB,qBAAqB,GAAGlB,UAAU,GAAG,CAAC;EAE5C,IAAMmB,WAAW,GAAGF,cAAc,CAACG,MAAM;EAEzC,IAAIC,MAAM,GAAG,CAAC;EACd,IAAIJ,cAAc,CAACI,MAAM,EAAE,CAAC,KAAKb,eAAe,EAAE;IAChD,MAAM,IAAIP,KAAK,CAAC,+BAA+B,CAAC;;EAGlD,IAAIqB,SAAS,GAAGL,cAAc,CAACI,MAAM,EAAE,CAAC;EACxC,IAAIC,SAAS,MAAMnB,SAAS,GAAG,CAAC,CAAC,EAAE;IACjCmB,SAAS,GAAGL,cAAc,CAACI,MAAM,EAAE,CAAC;;EAGtC,IAAIF,WAAW,GAAGE,MAAM,GAAGC,SAAS,EAAE;IACpC,MAAM,IAAIrB,KAAK,kCAAAC,MAAA,CACiBoB,SAAS,iBAAApB,MAAA,CAAYiB,WAAW,GAAGE,MAAM,iBAAa,CACrF;;EAGH,IAAIJ,cAAc,CAACI,MAAM,EAAE,CAAC,KAAKZ,eAAe,EAAE;IAChD,MAAM,IAAIR,KAAK,CAAC,uCAAuC,CAAC;;EAG1D,IAAMsB,OAAO,GAAGN,cAAc,CAACI,MAAM,EAAE,CAAC;EAExC,IAAIF,WAAW,GAAGE,MAAM,GAAG,CAAC,GAAGE,OAAO,EAAE;IACtC,MAAM,IAAItB,KAAK,gCAAAC,MAAA,CACeqB,OAAO,iBAAArB,MAAA,CAAYiB,WAAW,GAAGE,MAAM,GAAG,CAAC,iBAAa,CACrF;;EAGH,IAAIH,qBAAqB,GAAGK,OAAO,EAAE;IACnC,MAAM,IAAItB,KAAK,gCAAAC,MAAA,CACeqB,OAAO,mBAAArB,MAAA,CAAcgB,qBAAqB,qBAAiB,CACxF;;EAGH,IAAMM,OAAO,GAAGH,MAAM;EACtBA,MAAM,IAAIE,OAAO;EAEjB,IAAIN,cAAc,CAACI,MAAM,EAAE,CAAC,KAAKZ,eAAe,EAAE;IAChD,MAAM,IAAIR,KAAK,CAAC,uCAAuC,CAAC;;EAG1D,IAAMwB,OAAO,GAAGR,cAAc,CAACI,MAAM,EAAE,CAAC;EAExC,IAAIF,WAAW,GAAGE,MAAM,KAAKI,OAAO,EAAE;IACpC,MAAM,IAAIxB,KAAK,gCAAAC,MAAA,CAA6BuB,OAAO,qBAAAvB,MAAA,CAAgBiB,WAAW,GAAGE,MAAM,OAAG,CAAC;;EAG7F,IAAIH,qBAAqB,GAAGO,OAAO,EAAE;IACnC,MAAM,IAAIxB,KAAK,gCAAAC,MAAA,CACeuB,OAAO,mBAAAvB,MAAA,CAAcgB,qBAAqB,qBAAiB,CACxF;;EAGH,IAAMQ,OAAO,GAAGL,MAAM;EACtBA,MAAM,IAAII,OAAO;EAEjB,IAAIJ,MAAM,KAAKF,WAAW,EAAE;IAC1B,MAAM,IAAIlB,KAAK,4CAAAC,MAAA,CAA2CiB,WAAW,GAAGE,MAAM,oBAAgB,CAAC;;EAGjG,IAAMM,QAAQ,GAAG3B,UAAU,GAAGuB,OAAO;EACrC,IAAMK,QAAQ,GAAG5B,UAAU,GAAGyB,OAAO;EAErC,IAAMI,GAAG,GAAG,IAAIjB,UAAU,CAACe,QAAQ,GAAGJ,OAAO,GAAGK,QAAQ,GAAGH,OAAO,CAAC;EAEnE,KAAKJ,MAAM,GAAG,CAAC,EAAEA,MAAM,GAAGM,QAAQ,EAAE,EAAEN,MAAM,EAAE;IAC5CQ,GAAG,CAACR,MAAM,CAAC,GAAG,CAAC;;EAEjBQ,GAAG,CAACC,GAAG,CAACb,cAAc,CAACc,QAAQ,CAACP,OAAO,GAAGQ,IAAI,CAACC,GAAG,CAAC,CAACN,QAAQ,EAAE,CAAC,CAAC,EAAEH,OAAO,GAAGD,OAAO,CAAC,EAAEF,MAAM,CAAC;EAE7FA,MAAM,GAAGrB,UAAU;EAEnB,KAAK,IAAMkC,CAAC,GAAGb,MAAM,EAAEA,MAAM,GAAGa,CAAC,GAAGN,QAAQ,EAAE,EAAEP,MAAM,EAAE;IACtDQ,GAAG,CAACR,MAAM,CAAC,GAAG,CAAC;;EAEjBQ,GAAG,CAACC,GAAG,CAACb,cAAc,CAACc,QAAQ,CAACL,OAAO,GAAGM,IAAI,CAACC,GAAG,CAAC,CAACL,QAAQ,EAAE,CAAC,CAAC,EAAEF,OAAO,GAAGD,OAAO,CAAC,EAAEJ,MAAM,CAAC;EAE7F,OAAO,IAAA9B,WAAA,CAAA4C,MAAM,EAAC,IAAA9C,WAAA,CAAA+C,aAAa,EAACP,GAAG,CAAC,CAAC;AACnC;AAxFAQ,OAAA,CAAArB,SAAA,GAAAA,SAAA;AA0FA,SAASsB,YAAYA,CAACC,GAAe,EAAEC,KAAa,EAAEC,IAAY;EAChE,IAAIC,OAAO,GAAG,CAAC;EACf,OAAOF,KAAK,GAAGE,OAAO,GAAGD,IAAI,IAAIF,GAAG,CAACC,KAAK,GAAGE,OAAO,CAAC,KAAK,CAAC,EAAE;IAC3D,EAAEA,OAAO;;EAGX,IAAMC,SAAS,GAAGJ,GAAG,CAACC,KAAK,GAAGE,OAAO,CAAC,IAAIvC,SAAS;EACnD,IAAIwC,SAAS,EAAE;IACb,EAAED,OAAO;;EAGX,OAAOA,OAAO;AAChB;AAEA,SAAgBE,SAASA,CAACjC,SAA8B,EAAEZ,GAAQ;EAChEY,SAAS,GAAGD,gBAAgB,CAACC,SAAS,CAAC;EACvC,IAAMX,UAAU,GAAGF,mBAAmB,CAACC,GAAG,CAAC;EAE3C,IAAMkB,cAAc,GAAGN,SAAS,CAACS,MAAM;EACvC,IAAIH,cAAc,KAAKjB,UAAU,GAAG,CAAC,EAAE;IACrC,MAAM,IAAIe,SAAS,MAAAb,MAAA,CACbH,GAAG,8BAAAG,MAAA,CAAyBF,UAAU,GAAG,CAAC,sBAAAE,MAAA,CAAiBe,cAAc,OAAG,CACjF;;EAGH,IAAMU,QAAQ,GAAGW,YAAY,CAAC3B,SAAS,EAAE,CAAC,EAAEX,UAAU,CAAC;EACvD,IAAM4B,QAAQ,GAAGU,YAAY,CAAC3B,SAAS,EAAEX,UAAU,EAAEW,SAAS,CAACS,MAAM,CAAC;EACtE,IAAMG,OAAO,GAAGvB,UAAU,GAAG2B,QAAQ;EACrC,IAAMF,OAAO,GAAGzB,UAAU,GAAG4B,QAAQ;EAErC,IAAMiB,OAAO,GAAG,CAAC,GAAG,CAAC,GAAGtB,OAAO,GAAG,CAAC,GAAG,CAAC,GAAGE,OAAO;EAEjD,IAAMqB,WAAW,GAAGD,OAAO,GAAG1C,SAAS;EAEvC,IAAM0B,GAAG,GAAG,IAAIjB,UAAU,CAAC,CAACkC,WAAW,GAAG,CAAC,GAAG,CAAC,IAAID,OAAO,CAAC;EAE3D,IAAIxB,MAAM,GAAG,CAAC;EACdQ,GAAG,CAACR,MAAM,EAAE,CAAC,GAAGb,eAAe;EAC/B,IAAIsC,WAAW,EAAE;IACf;IACA;IACAjB,GAAG,CAACR,MAAM,EAAE,CAAC,GAAGwB,OAAO;GACxB,MAAM;IACL;IACA;IACAhB,GAAG,CAACR,MAAM,EAAE,CAAC,GAAGlB,SAAS,GAAG,CAAC;IAC7B;IACA0B,GAAG,CAACR,MAAM,EAAE,CAAC,GAAGwB,OAAO,GAAG,IAAI;;EAEhChB,GAAG,CAACR,MAAM,EAAE,CAAC,GAAGZ,eAAe;EAC/BoB,GAAG,CAACR,MAAM,EAAE,CAAC,GAAGE,OAAO;EACvB,IAAII,QAAQ,GAAG,CAAC,EAAE;IAChBE,GAAG,CAACR,MAAM,EAAE,CAAC,GAAG,CAAC;IACjBQ,GAAG,CAACC,GAAG,CAACnB,SAAS,CAACoB,QAAQ,CAAC,CAAC,EAAE/B,UAAU,CAAC,EAAEqB,MAAM,CAAC;IAClDA,MAAM,IAAIrB,UAAU;GACrB,MAAM;IACL6B,GAAG,CAACC,GAAG,CAACnB,SAAS,CAACoB,QAAQ,CAACJ,QAAQ,EAAE3B,UAAU,CAAC,EAAEqB,MAAM,CAAC;IACzDA,MAAM,IAAIrB,UAAU,GAAG2B,QAAQ;;EAEjCE,GAAG,CAACR,MAAM,EAAE,CAAC,GAAGZ,eAAe;EAC/BoB,GAAG,CAACR,MAAM,EAAE,CAAC,GAAGI,OAAO;EACvB,IAAIG,QAAQ,GAAG,CAAC,EAAE;IAChBC,GAAG,CAACR,MAAM,EAAE,CAAC,GAAG,CAAC;IACjBQ,GAAG,CAACC,GAAG,CAACnB,SAAS,CAACoB,QAAQ,CAAC/B,UAAU,CAAC,EAAEqB,MAAM,CAAC;GAChD,MAAM;IACLQ,GAAG,CAACC,GAAG,CAACnB,SAAS,CAACoB,QAAQ,CAAC/B,UAAU,GAAG4B,QAAQ,CAAC,EAAEP,MAAM,CAAC;;EAG5D,OAAOQ,GAAG;AACZ;AAvDAQ,OAAA,CAAAO,SAAA,GAAAA,SAAA"},"metadata":{},"sourceType":"script","externalDependencies":[]}